<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Camera Preview</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f6f7f9;
      --card: #ffffff;
      --border: #e5e7eb;
      --text: #111827;
      --muted: #6b7280;
      --btn: #111111;
      --btn-text: #ffffff;
      --radius: 12px;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      line-height: 1.5;
    }
    main {
      min-height: 100%;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 32px 16px;
    }
    .card {
      width: 100%;
      max-width: 720px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: 0 1px 2px rgba(0,0,0,0.04);
      padding: 24px;
    }
    h1 {
      font-size: 24px;
      line-height: 1.25;
      margin: 0 0 8px 0;
      font-weight: 700;
      letter-spacing: -0.01em;
    }
    p.desc {
      margin: 0 0 16px 0;
      color: var(--muted);
    }
    .preview {
      width: 100%;
      aspect-ratio: 16 / 9;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid var(--border);
    }
    video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      background: #000;
      display: block;
    }
    .controls {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 16px;
      flex-wrap: wrap;
    }
    button {
      background: var(--btn);
      color: var(--btn-text);
      border: none;
      padding: 10px 16px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
    }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .select-wrap {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    label {
      color: var(--muted);
      font-size: 14px;
    }
    select {
      appearance: none;
      border: 1px solid var(--border);
      background: #fff;
      padding: 8px 12px;
      border-radius: 10px;
      font-size: 14px;
      min-width: 220px;
    }
    ul.hints {
      margin: 12px 0 0 0;
      padding-left: 18px;
      color: var(--muted);
      font-size: 14px;
    }
    .status {
      margin-top: 8px;
      color: var(--muted);
      font-size: 14px;
      min-height: 20px;
    }
    .error { color: #b91c1c; }
    .sr-only {
      position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px;
      overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0;
    }
  </style>
</head>
<body>
  <main>
    <section class="card" aria-labelledby="title">
      <h1 id="title">Camera Preview</h1>
      <p class="desc">Start the camera to test permissions and device compatibility on desktop and mobile.</p>

      <div class="preview" aria-label="Camera preview area">
        <video id="preview" playsinline webkit-playsinline muted></video>
      </div>

      <div class="controls">
        <button id="startBtn" type="button">Start Camera</button>

        <div class="select-wrap">
          <label for="deviceSelect">Camera</label>
          <select id="deviceSelect" aria-label="Select camera device">
            <option value="" disabled selected>No cameras detected</option>
          </select>
        </div>
      </div>

      <div id="status" class="status" role="status" aria-live="polite"></div>

      <ul class="hints">
        <li>Tap “Start Camera” to satisfy mobile autoplay/permission requirements.</li>
        <li>Use https or http://localhost for camera access to work.</li>
        <li>On iOS, ensure Safari has Camera permission enabled in Settings.</li>
      </ul>
    </section>
  </main>

  <script>
    (function () {
      const video = document.getElementById('preview');
      const startBtn = document.getElementById('startBtn');
      const deviceSelect = document.getElementById('deviceSelect');
      const statusEl = document.getElementById('status');

      /** Keep track of current stream so we can stop it when switching devices */
      let currentStream = null;

      function setStatus(msg, isError = false) {
        statusEl.textContent = msg || '';
        statusEl.classList.toggle('error', !!isError);
        if (msg) console.log('[v0] Status:', msg);
      }

      function isSecure() {
        const host = location.hostname;
        return location.protocol === 'https:' || host === 'localhost' || host === '127.0.0.1';
      }

      function assertSupport() {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          throw new Error('Camera API not supported in this browser.');
        }
        if (!isSecure()) {
          throw new Error('Camera requires https or http://localhost.');
        }
      }

      async function stopStream() {
        if (currentStream) {
          currentStream.getTracks().forEach((t) => t.stop());
          currentStream = null;
        }
        if ('srcObject' in video) {
          video.srcObject = null;
        } else {
          video.src = '';
        }
        try { await video.pause(); } catch {}
      }

      async function listCameras() {
        try {
          const devices = await navigator.mediaDevices.enumerateDevices();
          const cams = devices.filter(d => d.kind === 'videoinput');
          deviceSelect.innerHTML = '';
          if (cams.length === 0) {
            const opt = document.createElement('option');
            opt.value = '';
            opt.textContent = 'No cameras detected';
            deviceSelect.appendChild(opt);
            deviceSelect.disabled = true;
            return;
          }
          cams.forEach((cam, idx) => {
            const opt = document.createElement('option');
            opt.value = cam.deviceId || '';
            // Label may be empty until permission is granted
            opt.textContent = cam.label || `Camera ${idx + 1}`;
            deviceSelect.appendChild(opt);
          });
          deviceSelect.disabled = false;
        } catch (e) {
          console.warn('[v0] enumerateDevices failed:', e);
          deviceSelect.innerHTML = '<option value=\"\">Unable to list cameras</option>';
          deviceSelect.disabled = true;
        }
      }

      function buildConstraints(deviceId) {
        // Prefer rear camera on mobile by default; fall back gracefully
        const videoConstraints = deviceId
          ? { deviceId: { exact: deviceId } }
          : {
              facingMode: { ideal: 'environment' },
              width: { ideal: 1280 },
              height: { ideal: 720 }
            };
        return { audio: false, video: videoConstraints };
      }

      async function startCamera(deviceId) {
        assertSupport();
        setStatus('Requesting camera permission…');

        await stopStream();

        // iOS/Safari-friendly flags
        video.muted = true;
        video.setAttribute('muted', '');
        video.setAttribute('playsinline', '');
        video.playsInline = true;

        let stream;
        try {
          stream = await navigator.mediaDevices.getUserMedia(buildConstraints(deviceId));
        } catch (err) {
          console.warn('[v0] First getUserMedia failed, trying fallback:', err);
          // Fallbacks: try generic camera, then user-facing
          try {
            stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
          } catch (err2) {
            try {
              stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false });
            } catch (err3) {
              console.error('[v0] All camera attempts failed:', err3);
              setStatus('Could not start camera. Please allow permission and ensure a camera is available.', true);
              throw err3;
            }
          }
        }

        currentStream = stream;
        try {
          if ('srcObject' in video) {
            video.srcObject = stream;
          } else {
            video.src = URL.createObjectURL(stream);
          }
          await video.play().catch(() => {}); // tolerate autoplay quirks
        } catch (e) {
          console.warn('[v0] Video play failed:', e);
        }

        // After permission, labels become available—refresh device list
        await listCameras();

        // Keep the selected option in sync if possible
        if (deviceId) {
          for (const opt of deviceSelect.options) {
            if (opt.value === deviceId) {
              deviceSelect.value = deviceId;
              break;
            }
          }
        }
        setStatus('Camera started.');
      }

      // Event wiring
      startBtn.addEventListener('click', async () => {
        startBtn.disabled = true;
        setStatus('');
        try {
          const chosen = deviceSelect.value || '';
          await startCamera(chosen);
        } catch (e) {
          setStatus(e && e.message ? e.message : 'Failed to start camera.', true);
        } finally {
          // Re-enable so the user can retry or switch devices
          startBtn.disabled = false;
        }
      });

      deviceSelect.addEventListener('change', async (e) => {
        const chosen = e.target.value || '';
        if (currentStream) {
          // If already running, switch immediately
          try {
            await startCamera(chosen);
          } catch {}
        }
      });

      // Initial checks and populate device list (labels may be blank until permission)
      (async function init() {
        if (!isSecure()) {
          setStatus('Open over https or http://localhost to use the camera.', true);
        }
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          setStatus('Camera API not supported in this browser.', true);
          startBtn.disabled = true;
          return;
        }
        await listCameras();
      })();

      // Clean up on page hide/unload to free the camera
      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'hidden') stopStream();
      });
      window.addEventListener('beforeunload', () => stopStream());
    })();
  </script>
</body>
</html>